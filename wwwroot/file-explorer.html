<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ãƒ•ã‚¡ã‚¤ãƒ«ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©</title>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- jQuery UI (FancyTreeã®ä¾å­˜) -->
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    
    <!-- FancyTree CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/jquery.fancytree/2.38.5/skin-win8-n/ui.fancytree.min.css" rel="stylesheet">
    
    <!-- FancyTree JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.fancytree/2.38.5/jquery.fancytree-all.min.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 10px;
            font-family: Arial, sans-serif;
            background: #f5f5f5;
        }
        
        #tree {
            border: 1px solid #ccc;
            background: white;
            padding: 5px;
            height: calc(100vh - 80px);
            overflow: auto;
        }
        
        .fancytree-container {
            border: none;
        }
        
        .fancytree-node {
            padding: 2px 0;
        }
        
        .fancytree-title {
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .fancytree-title:hover {
            background: #e8f4fd;
        }
        
        .fancytree-focused .fancytree-title {
            background: #3399ff;
            color: white;
        }
        
        .fancytree-selected .fancytree-title {
            background: #0078d4;
            color: white;
        }
        
        .fancytree-expander {
            margin-right: 3px;
        }
        
        .fancytree-icon {
            margin-right: 3px;
        }
        
        .file-info {
            font-size: 11px;
            color: #666;
            margin-left: 5px;
        }
        
        .toolbar {
            margin-bottom: 10px;
            padding: 5px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        
        .toolbar button {
            margin-right: 5px;
            padding: 5px 10px;
            border: 1px solid #ccc;
            background: #f8f8f8;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .toolbar button:hover {
            background: #e8f4fd;
        }
        
        .status {
            margin-top: 10px;
            padding: 5px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <button onclick="expandAll()">ã™ã¹ã¦å±•é–‹</button>
        <button onclick="collapseAll()">ã™ã¹ã¦æŠ˜ã‚ŠãŸãŸã¿</button>
        <button onclick="getSelectedFiles()">é¸æŠãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—</button>
        <button onclick="debugTree()">ãƒ‡ãƒãƒƒã‚°</button>
    </div>
    
    <div id="tree"></div>
    
    <div class="status" id="status">æº–å‚™å®Œäº†</div>
    
    <div id="debug" style="margin-top: 10px; padding: 10px; background: #f0f0f0; border: 1px solid #ccc; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; display: none;">
        <strong>ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</strong><br>
        <div id="debugContent"></div>
    </div>
    
    <script>
        let fancyTree = null;
        let allFiles = [];
        
        // FancyTreeåˆæœŸåŒ–
        function initFancyTree() {
            $("#tree").fancytree({
                extensions: ["childcounter", "filter"],
                checkbox: true,
                selectMode: 2, // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹é¸æŠãƒ¢ãƒ¼ãƒ‰ï¼ˆè¤‡æ•°é¸æŠï¼‰
                keyboard: true,
                quicksearch: true,
                childcounter: {
                    deep: true,
                    hideZeros: true,
                    hideExpanded: true
                },
                filter: {
                    autoApply: true,
                    autoExpand: true,
                    counter: true,
                    hideExpanders: false,
                    highlight: true,
                    leavesOnly: false,
                    nodata: true,
                    mode: "dimm"
                },
                source: [],
                icon: function(event, data) {
                    // ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¤ã‚³ãƒ³è¨­å®š
                    if (data.node.isFolder()) {
                        return "ğŸ“";
                    } else {
                        const ext = data.node.data.fileInfo?.extension;
                        const icons = {
                            '.txt': 'ğŸ“„',
                            '.js': 'ğŸ“œ',
                            '.html': 'ğŸŒ',
                            '.css': 'ğŸ¨',
                            '.json': 'ğŸ“‹',
                            '.xml': 'ğŸ“„',
                            '.csv': 'ğŸ“Š',
                            '.pdf': 'ğŸ“•',
                            '.doc': 'ğŸ“˜',
                            '.docx': 'ğŸ“˜',
                            '.xls': 'ğŸ“—',
                            '.xlsx': 'ğŸ“—',
                            '.ppt': 'ğŸ“™',
                            '.pptx': 'ğŸ“™',
                            '.jpg': 'ğŸ–¼ï¸',
                            '.jpeg': 'ğŸ–¼ï¸',
                            '.png': 'ğŸ–¼ï¸',
                            '.gif': 'ğŸ–¼ï¸',
                            '.mp3': 'ğŸµ',
                            '.mp4': 'ğŸ¬',
                            '.zip': 'ğŸ—œï¸',
                            '.rar': 'ğŸ—œï¸'
                        };
                        return icons[ext] || 'ğŸ“„';
                    }
                },
                renderTitle: function(event, data) {
                    // ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚¤ãƒˆãƒ«è¡¨ç¤º
                    const node = data.node;
                    const title = node.title;
                    
                    if (node.data.fileInfo) {
                        const file = node.data.fileInfo;
                        const size = formatFileSize(file.size);
                        const date = new Date(file.lastModified).toLocaleDateString();
                        return `${title} <span class="file-info">${size} - ${date}</span>`;
                    }
                    return title;
                },
                lazyLoad: function(event, data) {
                    // å­ãƒãƒ¼ãƒ‰ã®é…å»¶èª­ã¿è¾¼ã¿
                    data.result = loadChildren(data.node);
                },
                activate: function(event, data) {
                    // ãƒãƒ¼ãƒ‰ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ãªã£ãŸã¨ã
                    updateStatus(`é¸æŠ: ${data.node.title}`);
                },
                select: function(event, data) {
                    // é¸æŠçŠ¶æ…‹ãŒå¤‰æ›´ã•ã‚ŒãŸã¨ã
                    const selectedNodes = $("#tree").fancytree("getTree").getSelectedNodes();
                    const selectedFiles = selectedNodes.filter(node => !node.isFolder());
                    updateStatus(`${selectedFiles.length}ä»¶ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠä¸­`);
                }
            });
            
            fancyTree = $("#tree").fancytree("getTree");
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’æ•´å½¢
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
        
        // C#ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã£ã¦ãƒ„ãƒªãƒ¼ã‚’æ§‹ç¯‰
        function loadFiles(fileData) {
            try {
                console.log('loadFiles called with data length:', fileData.length);
                logDebug(`å—ä¿¡ãƒ‡ãƒ¼ã‚¿é•·: ${fileData.length}æ–‡å­—`);
                
                allFiles = JSON.parse(fileData);
                console.log('Parsed files:', allFiles.length);
                logDebug(`è§£æãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${allFiles.length}`);
                
                if (allFiles.length === 0) {
                    logDebug('ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“');
                    updateStatus('ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                // æœ€åˆã®æ•°ä»¶ã‚’è¡¨ç¤º
                for (let i = 0; i < Math.min(5, allFiles.length); i++) {
                    logDebug(`ãƒ•ã‚¡ã‚¤ãƒ«${i}: ${allFiles[i].relativePath} (${allFiles[i].fullPath})`);
                }
                
                const treeData = buildTreeData(allFiles);
                console.log('Tree data built:', treeData);
                logDebug(`ãƒ„ãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿: ${treeData.length}ä»¶`);
                
                if (fancyTree) {
                    fancyTree.reload(treeData);
                    logDebug('FancyTreeãƒªãƒ­ãƒ¼ãƒ‰å®Œäº†');
                } else {
                    logDebug('FancyTreeãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                updateStatus(`${allFiles.length}ä»¶ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
            } catch (error) {
                console.error('loadFiles error:', error);
                logDebug(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                updateStatus(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }
        
        // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
        function logDebug(message) {
            const debugContent = document.getElementById('debugContent');
            const timestamp = new Date().toLocaleTimeString();
            debugContent.innerHTML += `[${timestamp}] ${message}<br>`;
            debugContent.scrollTop = debugContent.scrollHeight;
            console.log('[DEBUG]', message);
        }
        
        // ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        function debugTree() {
            const debugDiv = document.getElementById('debug');
            debugDiv.style.display = debugDiv.style.display === 'none' ? 'block' : 'none';
            
            if (debugDiv.style.display === 'block') {
                logDebug('=== ãƒ‡ãƒãƒƒã‚°é–‹å§‹ ===');
                logDebug(`FancyTreeçŠ¶æ…‹: ${fancyTree ? 'åˆæœŸåŒ–æ¸ˆã¿' : 'æœªåˆæœŸåŒ–'}`);
                logDebug(`jQueryãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${$.fn.jquery}`);
                logDebug(`jQuery UIãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${$.ui.version}`);
                logDebug(`FancyTreeãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${$.ui.fancytree ? 'åˆ©ç”¨å¯èƒ½' : 'ä¸æ˜'}`);
                
                if (fancyTree) {
                    const nodeCount = fancyTree.count();
                    logDebug(`ãƒ„ãƒªãƒ¼ãƒãƒ¼ãƒ‰æ•°: ${nodeCount}`);
                }
            }
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ãƒ„ãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’æ§‹ç¯‰
        function buildTreeData(files) {
            const tree = {};
            
            files.forEach(file => {
                const parts = file.relativePath.split('/');
                let current = tree;
                let currentPath = '';
                
                parts.forEach((part, index) => {
                    currentPath = currentPath ? currentPath + '/' + part : part;
                    
                    if (!current[part]) {
                        // ã“ã®ãƒ‘ã‚¹ãŒãƒ•ã‚©ãƒ«ãƒ€ã‹ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚’åˆ¤å®š
                        const isFolder = files.some(f => 
                            f.relativePath !== file.relativePath && 
                            f.relativePath.startsWith(currentPath + '/')
                        );
                        
                        current[part] = {
                            title: part,
                            folder: isFolder,
                            key: file.fullPath,
                            expanded: false,
                            children: isFolder ? {} : undefined,
                            fileInfo: !isFolder ? file : undefined,
                            path: currentPath
                        };
                    }
                    
                    // å­è¦ç´ ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ç§»å‹•
                    if (current[part].children) {
                        current = current[part].children;
                    }
                });
            });
            
            // ãƒ„ãƒªãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é…åˆ—ã«å¤‰æ›
            function convertToArray(obj) {
                return Object.values(obj).map(item => {
                    if (item.children && typeof item.children === 'object') {
                        item.children = convertToArray(item.children);
                        // ãƒ•ã‚©ãƒ«ãƒ€ã¯å¸¸ã«childrenã‚’æŒã¤ã‚ˆã†ã«ã™ã‚‹
                        if (item.children.length === 0) {
                            item.children = []; // ç©ºé…åˆ—ã‚’è¨­å®š
                        }
                    }
                    return item;
                });
            }
            
            return convertToArray(tree);
        }
        
        // å­ãƒãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã‚€ï¼ˆé…å»¶èª­ã¿è¾¼ã¿ç”¨ï¼‰
        function loadChildren(node) {
            if (!node.data.fileInfo) {
                return []; // ãƒ•ã‚©ãƒ«ãƒ€ã®å ´åˆã¯ç©ºã‚’è¿”ã™ï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯å­ã‚’è¿”ã™ï¼‰
            }
            return [];
        }
        
        // ã™ã¹ã¦å±•é–‹
        function expandAll() {
            fancyTree.visit(function(node) {
                node.setExpanded(true);
            });
        }
        
        // ã™ã¹ã¦æŠ˜ã‚ŠãŸãŸã¿
        function collapseAll() {
            fancyTree.visit(function(node) {
                node.setExpanded(false);
            });
        }
        
        // é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
        function getSelectedFiles() {
            try {
                console.log('getSelectedFiles called');
                
                if (!fancyTree) {
                    console.error('FancyTree is not initialized');
                    logDebug('FancyTreeãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    return [];
                }
                
                const selectedFiles = [];
                
                fancyTree.visit(function(node) {
                    if (node.isSelected() && !node.isFolder()) {
                        console.log(`Selected file: ${node.title}`);
                        logDebug(`é¸æŠãƒ•ã‚¡ã‚¤ãƒ«: ${node.title}`);
                        selectedFiles.push(node.data.fileInfo);
                    }
                });
                
                console.log('Selected files:', selectedFiles.length);
                logDebug(`é¸æŠãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${selectedFiles.length}`);
                
                // C#ã«é¸æŠãƒ•ã‚¡ã‚¤ãƒ«ã‚’é€šçŸ¥
                if (window.chrome && window.chrome.webview && window.chrome.webview.hostObjects) {
                    window.chrome.webview.hostObjects.fileHelper.setSelectedFiles(JSON.stringify(selectedFiles));
                }
                
                updateStatus(`${selectedFiles.length}ä»¶ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¾ã—ãŸ`);
                return selectedFiles;
            } catch (error) {
                console.error('getSelectedFiles error:', error);
                logDebug(`é¸æŠãƒ•ã‚¡ã‚¤ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                updateStatus(`é¸æŠã‚¨ãƒ©ãƒ¼: ${error.message}`);
                return [];
            }
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }
        
        // åˆæœŸåŒ–
        $(document).ready(function() {
            console.log('Document ready, checking libraries');
            logDebug('ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæº–å‚™å®Œäº†');
            
            // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒã‚§ãƒƒã‚¯
            if (typeof jQuery === 'undefined') {
                logDebug('jQueryãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                updateStatus('jQueryèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼');
                return;
            }
            
            if (typeof $.ui === 'undefined') {
                logDebug('jQuery UIãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                updateStatus('jQuery UIèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼');
                return;
            }
            
            if (typeof $.ui.fancytree === 'undefined') {
                logDebug('FancyTreeãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                updateStatus('FancyTreeèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼');
                return;
            }
            
            logDebug('ã™ã¹ã¦ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');
            
            try {
                initFancyTree();
                logDebug('FancyTreeåˆæœŸåŒ–å®Œäº†');
                updateStatus('FancyTreeåˆæœŸåŒ–å®Œäº†');
            } catch (error) {
                console.error('Initialization error:', error);
                logDebug(`åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                updateStatus(`åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        });
    </script>
</body>
</html>
